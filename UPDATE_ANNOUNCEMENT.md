# 公告功能更新说明

## 更新内容

本次更新为客户端添加了**系统公告显示功能**，可以在主页顶部展示来自服务器的公告信息。

## 前端更新

### 1. 新增文件
- `ANNOUNCEMENT_API.md` - 后端API接口文档

### 2. 修改文件

#### `modules/keyManager.js`
- ✅ 添加 `getAnnouncement()` 静态方法，用于从后端获取公告

#### `renderer/index.html`
- ✅ 在主页顶部添加公告显示区域
- ✅ 包含公告标题、内容、时间和关闭按钮

#### `renderer/style.css`
- ✅ 添加公告卡片样式
- ✅ 渐变紫色背景，带图案装饰
- ✅ 响应式动画效果

#### `renderer/renderer.js`
- ✅ 添加 `loadAnnouncement()` 函数 - 获取并显示公告
- ✅ 添加 `displayAnnouncement()` 函数 - 渲染公告内容
- ✅ 添加 `closeAnnouncement()` 函数 - 关闭公告
- ✅ 在初始化时自动加载公告

#### `preload.js`
- ✅ 添加 `getAnnouncement` IPC 接口

#### `main.js`
- ✅ 添加 `get-announcement` IPC 处理器

## 功能特性

### 1. 自动获取
- 客户端启动时自动从服务器获取公告
- 调用接口: `GET /api/client/announcement`

### 2. 智能显示
- 有公告时，在主页顶部显示醒目的公告卡片
- 没有公告或获取失败时，自动隐藏公告区域
- 支持多行文本显示

### 3. 用户交互
- 用户可以点击关闭按钮隐藏公告
- 关闭后不会再次显示（除非重启客户端）

### 4. 样式设计
- 渐变紫色背景 (#667eea → #764ba2)
- 带有图案装饰的背景
- 平滑的动画效果
- 显示发布时间

## 后端需要做的工作

### 1. 实现 API 接口

需要在后端添加公告接口:

**接口地址**: `GET /api/client/announcement`

**响应格式**:
```json
{
  "content": "公告内容，支持换行",
  "created_at": "2025-12-08T00:00:00Z",
  "updated_at": "2025-12-08T12:00:00Z"
}
```

### 2. 添加管理功能

在管理后台添加:
- 公告列表页面
- 创建/编辑公告页面
- 启用/禁用公告功能
- 同时只能有一条启用的公告

详细的实现说明请查看 `ANNOUNCEMENT_API.md` 文档。

## 测试步骤

### 前端测试（无需后端）

1. 启动客户端
2. 如果后端未实现接口，公告区域会自动隐藏
3. 在日志中会看到 "获取公告失败" 的提示

### 完整测试（需要后端）

1. 后端实现公告接口
2. 在管理后台创建一条公告
3. 启动客户端
4. 查看主页是否显示公告
5. 点击关闭按钮测试
6. 重启客户端，公告应该再次显示

## 示例效果

```
┌─────────────────────────────────────────────────────┐
│ 📢 系统公告                                    ✕    │
│                                                     │
│ 欢迎使用 PaperCrane-Windsurf！                      │
│                                                     │
│ 最新更新：                                          │
│ - 新增公告功能                                      │
│ - 优化账号切换速度                                  │
│                                                     │
│ ─────────────────────────────────────────────────  │
│ 发布时间: 2025-12-08 12:00                         │
└─────────────────────────────────────────────────────┘
```

## 技术细节

### 前端实现
- 使用 Electron IPC 通信获取公告
- 公告内容使用 `textContent` 防止 XSS
- 支持 `\n` 换行符显示
- 使用 CSS 动画实现平滑展示

### 错误处理
- 网络错误: 自动隐藏公告区域
- 接口不存在: 自动隐藏公告区域
- 内容为空: 自动隐藏公告区域
- 所有错误都会在日志中记录

### 性能优化
- 公告获取延迟 300ms，避免阻塞首屏
- 获取失败不影响其他功能
- 超时时间 10 秒

## 后续优化建议

1. **本地缓存**: 缓存公告内容，减少网络请求
2. **版本控制**: 记录公告版本，避免重复显示
3. **富文本**: 支持 Markdown 格式
4. **多语言**: 根据客户端语言显示不同公告
5. **定时刷新**: 定期检查公告更新

## 注意事项

1. 公告接口是**公开接口**，无需认证
2. 后端应对公告内容进行 **HTML 转义**，防止 XSS
3. 建议限制公告内容长度（如 500 字符）
4. 建议添加**缓存**，减轻服务器压力
5. 客户端已做好**容错处理**，后端未实现不影响使用

## 版本信息

- 更新日期: 2025-12-08
- 客户端版本: 1.0.1
- 涉及模块: 前端UI、IPC通信、后端接口
