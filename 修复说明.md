# 重新安装插件功能修复说明

## 问题描述

用户在使用客户端的"一键安装"功能时遇到以下问题：
- 客户端成功删除了旧插件
- 但在尝试重新安装时失败，错误信息：`Please restart Windsurf before reinstalling`
- 用户重新打开 Windsurf 后发现插件确实被删除了，但没有重新安装

## 根本原因

Windsurf 的扩展管理系统在插件被删除后，需要完全释放相关资源才能重新安装。即使进程已经关闭，扩展系统仍然可能保留某些锁定状态，导致立即重新安装失败。

## 修复方案

### 1. 增加等待时间（`main.js:1582-1587`）

在关闭 Windsurf 后，增加 5 秒等待时间，确保扩展系统完全释放：

```javascript
// 如果刚刚关闭了 Windsurf，需要额外等待以确保扩展系统完全释放
if (wasWindsurfRunning) {
  console.log('[安装插件] 等待扩展系统完全释放 (5秒)...');
  event.sender.send('switch-progress', { step: 'info', message: '⏳ 等待系统释放资源...' });
  await new Promise(resolve => setTimeout(resolve, 5000));
}
```

### 2. 延迟安装脚本（`main.js:1625-1678`）

如果仍然遇到 "Please restart" 错误，自动创建 PowerShell 延迟安装脚本：

```javascript
if (cliError.message && cliError.message.includes('Please restart')) {
  // 创建延迟安装脚本
  const scriptContent = `# Windsurf Continue Pro 延迟安装脚本
Write-Host "等待 3 秒后开始安装..." -ForegroundColor Cyan
Start-Sleep -Seconds 3

Write-Host "正在安装 Windsurf Continue Pro..." -ForegroundColor Yellow
try {
    & "${cliPath}" --install-extension "${vsixPath}" --force
    Write-Host "✓ 插件安装成功！" -ForegroundColor Green
} catch {
    Write-Host "❌ 安装失败: $_" -ForegroundColor Red
}

Start-Sleep -Seconds 5
Remove-Item -Path "$PSCommandPath" -Force -ErrorAction SilentlyContinue
`;
  
  // 启动延迟脚本（后台运行）
  spawn('powershell.exe', [...], { detached: true, stdio: 'ignore' }).unref();
  
  return {
    success: true,
    delayed: true,
    message: '插件正在后台安装中...\n\n由于系统限制，安装脚本将在 3 秒后自动执行。\n请稍等片刻，然后重启 Windsurf 即可使用插件。'
  };
}
```

### 3. 前端处理延迟模式（`renderer.js:2318-2328`）

前端代码识别延迟安装模式，跳过后续步骤并提示用户：

```javascript
// 检查是否是延迟安装模式
if (installResult.delayed) {
  log('⏳ 插件正在后台安装中...', 'info');
  showToast(installResult.message, 'info', 8000);
  
  // 延迟安装模式下，不执行后续步骤，直接返回
  btn.disabled = false;
  btn.innerHTML = originalHtml;
  try { lucide.createIcons(); } catch (e) {}
  return;
}
```

## 工作流程

### 正常流程
1. 关闭 Windsurf
2. 删除旧插件
3. 等待 5 秒
4. 使用 CLI 安装插件
5. 验证安装
6. 配置 MCP
7. 启动 Windsurf

### 延迟安装流程
1. 关闭 Windsurf
2. 删除旧插件
3. 等待 5 秒
4. 尝试使用 CLI 安装 → 失败（需要重启）
5. 创建延迟安装脚本
6. 启动脚本（后台运行）
7. 提示用户等待
8. 脚本在 3 秒后自动安装插件
9. 用户手动重启 Windsurf

## 测试步骤

1. 打开客户端
2. 点击"一键安装"按钮
3. 观察安装过程：
   - 如果顺利完成，插件会自动安装并启动 Windsurf
   - 如果触发延迟模式，会看到提示信息，等待 3 秒后手动重启 Windsurf
4. 重启 Windsurf 后，检查插件是否已安装

## 修改文件

- `d:\zmoney\Windsurf-tool\main.js` - 后端安装逻辑
- `d:\zmoney\Windsurf-tool\renderer\renderer.js` - 前端处理逻辑

## 版本信息

- 修复日期：2024-12-13
- 客户端版本：1.0.1
